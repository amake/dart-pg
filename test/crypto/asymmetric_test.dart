import 'dart:typed_data';

import 'package:dart_pg/src/crypto/asymmetric/elgamal.dart';
import 'package:dart_pg/src/crypto/signer/dsa.dart';
import 'package:dart_pg/src/helpers.dart';
import 'package:pointycastle/api.dart';
import 'package:faker/faker.dart';
import 'package:test/test.dart';

void main() {
  final faker = Faker();

  group('ElGamal encryption tests', () {
    test('Enc 512 Test', () {
      final p512 = BigInt.parse(
          '9494fec095f3b85ee286542b3836fc81a5dd0a0349b4c239dd38744d488cf8e31db8bcb7d33b41abb9e5a33cca9144b1cef332c94bf0573bf047a3aca98cdf3b',
          radix: 16);
      final g512 = BigInt.parse(
          '153d5d6172adb43045b68ae8e1de1070b6137005686d29d3d73a7749199681ee5b212c9b96bfdcfa5b20cd5e3fd2044895d609cf9b410b7a0f12ca1cb9a428cc',
          radix: 16);

      _elGamalEncryptionTest(p512, g512, 512);
    });

    test('Enc 768 Test', (() {
      final p768 = BigInt.parse(
          '8c9dd223debed1b80103b8b309715be009d48860ed5ae9b9d5d8159508efd802e3ad4501a7f7e1cfec78844489148cd72da24b21eddd01aa624291c48393e277cfc529e37075eccef957f3616f962d15b44aeab4039d01b817fde9eaa12fd73f',
          radix: 16);
      final g768 = BigInt.parse(
          '7c240073c1316c621df461b71ebb0cdcc90a6e5527e5e126633d131f87461c4dc4afc60c2cb0f053b6758871489a69613e2a8b4c8acde23954c08c81cbd36132cfd64d69e4ed9f8e51ed6e516297206672d5c0a69135df0a5dcf010d289a9ca1',
          radix: 16);

      _elGamalEncryptionTest(p768, g768, 768);
    }));

    test('Enc 1024 Test', (() {
      final p1024 = BigInt.parse(
          'a00e283b3c624e5b2b4d9fbc2653b5185d99499b00fd1bf244c6f0bb817b4d1c451b2958d62a0f8a38caef059fb5ecd25d75ed9af403f5b5bdab97a642902f824e3c13789fed95fa106ddfe0ff4a707c85e2eb77d49e68f2808bcea18ce128b178cd287c6bc00efa9a1ad2a673fe0dceace53166f75b81d6709d5f8af7c66bb7',
          radix: 16);
      final g1024 = BigInt.parse(
          '1db17639cdf96bc4eabba19454f0b7e5bd4e14862889a725c96eb61048dcd676ceb303d586e30f060dbafd8a571a39c4d823982117da5cc4e0f89c77388b7a08896362429b94a18a327604eb7ff227bffbc83459ade299e57b5f77b50fb045250934938efa145511166e3197373e1b5b1e52de713eb49792bedde722c6717abf',
          radix: 16);

      _elGamalEncryptionTest(p1024, g1024, 1024);
    }));

    test('Diffie Hellman key agreement test', (() {
      final prime = BigInt.parse(
          'ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aacaa68ffffffffffffffff',
          radix: 16);
      final generator = BigInt.two;
      final alicePrivate = BigInt.parse(
          '22606eda7960458bc9d65f46dd96f114f9a004f0493c1f262139d2c8063b733162e876182ca3bf063ab1a167abdb7f03e0a225a6205660439f6ce46d252069ff',
          radix: 16);
      final bobPrivate = BigInt.parse(
          '6e3efa13a96025d63e4b0d88a09b3a46ddfe9dd3bc9d16554898c02b4ac181f0ceb4e818664b12f02c71a07215c400f988352a4779f3e88836f7c3d3b3c739de',
          radix: 16);

      final alicePublic = generator.modPow(alicePrivate, prime);
      final bobPublic = generator.modPow(bobPrivate, prime);

      final aliceShared = bobPublic.modPow(alicePrivate, prime);
      final bobShared = alicePublic.modPow(bobPrivate, prime);
      expect(aliceShared, bobShared);
    }));
  });

  group('DSA signer tests', (() {
    final pValue = Uint8List.fromList([
      0x08,
      0x00,
      0xa8,
      0x85,
      0x5c,
      0x28,
      0x05,
      0x94,
      0x03,
      0xbe,
      0x07,
      0x6c,
      0x13,
      0x3e,
      0x65,
      0xfb,
      0xb5,
      0xe1,
      0x99,
      0x7c,
      0xfa,
      0x84,
      0xe3,
      0xac,
      0x47,
      0xa5,
      0xc4,
      0x46,
      0xd8,
      0x5f,
      0x44,
      0xe9,
      0xc1,
      0x6b,
      0x69,
      0xf7,
      0x10,
      0x76,
      0x49,
      0xa7,
      0x25,
      0x85,
      0xf4,
      0x1b,
      0xed,
      0xc6,
      0x60,
      0xc4,
      0x5b,
      0xaa,
      0xd4,
      0x87,
      0xd6,
      0x8f,
      0x92,
      0x56,
      0x7d,
      0x55,
      0x3f,
      0x45,
      0xae,
      0x12,
      0x73,
      0xda,
      0x29,
      0x8c,
      0xba,
      0x32,
      0xcc,
      0xd7,
      0xa4,
      0xd0,
      0x24,
      0xb0,
      0x7c,
      0xd8,
      0x0c,
      0x3a,
      0x91,
      0x6f,
      0x98,
      0x40,
      0x9c,
      0x9a,
      0xa8,
      0xcc,
      0x28,
      0x27,
      0x95,
      0x0b,
      0xe1,
      0x5b,
      0xb9,
      0x3b,
      0x1c,
      0x1c,
      0xd2,
      0xec,
      0xab,
      0x07,
      0x25,
      0x8d,
      0x7a,
      0x2a,
      0x2b,
      0x16,
      0x14,
      0xe8,
      0xda,
      0x71,
      0xd2,
      0xab,
      0xba,
      0x85,
      0x14,
      0x0d,
      0xc5,
      0xe0,
      0x88,
      0xeb,
      0xa5,
      0xe2,
      0xd5,
      0x48,
      0x3d,
      0x74,
      0x0c,
      0x41,
      0xeb,
      0xfd,
      0xb6,
      0x4e,
      0xf9,
      0x2c,
      0x82,
      0x17,
      0xdd,
      0x64,
      0x1e,
      0x19,
      0x39,
      0xa3,
      0x7f,
      0xf9,
      0x00,
      0xcd,
      0x9b,
      0xda,
      0x2e,
      0xbd,
      0x71,
      0x12,
      0xdf,
      0x0d,
      0x7c,
      0x0a,
      0x6b,
      0x2d,
      0x21,
      0x3b,
      0x9c,
      0x66,
      0x93,
      0x4a,
      0x1e,
      0x90,
      0x79,
      0xd3,
      0x5a,
      0x5b,
      0xe5,
      0xb9,
      0x94,
      0x1b,
      0xe6,
      0x47,
      0x99,
      0x06,
      0x98,
      0xd8,
      0x2a,
      0xe5,
      0xe2,
      0xa6,
      0x95,
      0x6a,
      0x07,
      0xc8,
      0xac,
      0x7c,
      0xe9,
      0xfc,
      0xa2,
      0x6a,
      0x16,
      0x2c,
      0x94,
      0x98,
      0xbd,
      0x91,
      0x0a,
      0x7c,
      0x7c,
      0x2c,
      0xb9,
      0x7e,
      0xa2,
      0x51,
      0x8b,
      0x45,
      0x1d,
      0x46,
      0x34,
      0xa8,
      0x52,
      0x2b,
      0xdd,
      0xd9,
      0xa8,
      0xbc,
      0x46,
      0x78,
      0x66,
      0xe1,
      0x72,
      0x11,
      0xf1,
      0xcb,
      0x1a,
      0xb6,
      0x4e,
      0x05,
      0x54,
      0xf7,
      0xe9,
      0xbe,
      0x4c,
      0x25,
      0x59,
      0x08,
      0x9f,
      0xf8,
      0xea,
      0x25,
      0x97,
      0x33,
      0xd6,
      0xc9,
      0x0f,
      0x59,
      0x0e,
      0xfd,
      0x9f,
      0xdc,
      0xe2,
      0xc0,
      0xcf,
      0x2f,
    ]).toBigInt();
    final qValue = Uint8List.fromList([
      0x01,
      0x00,
      0xe1,
      0x72,
      0x2c,
      0xd0,
      0xbb,
      0x1a,
      0x4f,
      0xb6,
      0xb6,
      0x95,
      0x77,
      0x71,
      0x2e,
      0x01,
      0x48,
      0x3e,
      0x35,
      0x54,
      0x64,
      0x2b,
      0xed,
      0x40,
      0x5f,
      0x65,
      0x0c,
      0x57,
      0x28,
      0x5f,
      0xfd,
      0xfd,
      0xff,
      0xd7,
    ]).toBigInt();
    final gValue = Uint8List.fromList([
      0x07,
      0xff,
      0x5d,
      0x9f,
      0xc4,
      0xb5,
      0x63,
      0x25,
      0x9d,
      0x72,
      0x88,
      0xe5,
      0x53,
      0x46,
      0x98,
      0xe3,
      0xe9,
      0x62,
      0xcb,
      0x0c,
      0xa1,
      0xb7,
      0x75,
      0x9f,
      0x18,
      0x41,
      0x94,
      0x32,
      0x28,
      0x29,
      0x6d,
      0x69,
      0xe0,
      0x3f,
      0x7d,
      0x7b,
      0x2b,
      0x06,
      0x5a,
      0x33,
      0x5c,
      0xd4,
      0x36,
      0x31,
      0x09,
      0x54,
      0x85,
      0x9d,
      0xb8,
      0x20,
      0xfe,
      0xda,
      0xfc,
      0xcd,
      0x1f,
      0xb1,
      0x2c,
      0x15,
      0x08,
      0x9d,
      0x32,
      0x53,
      0x2f,
      0xc1,
      0x42,
      0x22,
      0x69,
      0xff,
      0x67,
      0x2e,
      0x39,
      0x97,
      0x50,
      0x66,
      0x39,
      0xda,
      0xcf,
      0xfd,
      0x64,
      0x6f,
      0x91,
      0x05,
      0x64,
      0x37,
      0xc5,
      0x07,
      0x24,
      0xaa,
      0x40,
      0xa0,
      0x75,
      0x82,
      0x1d,
      0x97,
      0x96,
      0x12,
      0xf1,
      0xbd,
      0x9e,
      0x09,
      0x26,
      0x3c,
      0x97,
      0x5d,
      0x57,
      0xb8,
      0x5c,
      0x7d,
      0x89,
      0x03,
      0x82,
      0xcd,
      0x40,
      0xe5,
      0x03,
      0xe6,
      0x4a,
      0xfb,
      0xbc,
      0xd2,
      0xef,
      0x7a,
      0x89,
      0x02,
      0x08,
      0xc8,
      0x52,
      0xfa,
      0x97,
      0x74,
      0x66,
      0x32,
      0xae,
      0xa6,
      0x52,
      0x4b,
      0xef,
      0x5f,
      0xce,
      0x91,
      0x23,
      0x3f,
      0xab,
      0x9d,
      0x62,
      0x21,
      0xef,
      0x48,
      0x6d,
      0x07,
      0x5a,
      0xba,
      0xdf,
      0x00,
      0x91,
      0x54,
      0xea,
      0x5c,
      0xfa,
      0x4b,
      0x16,
      0x28,
      0x1a,
      0xce,
      0x48,
      0xb7,
      0x5c,
      0x50,
      0xa5,
      0x59,
      0xa4,
      0xb4,
      0xaf,
      0x1f,
      0xeb,
      0x8d,
      0x58,
      0x3f,
      0x0a,
      0xa5,
      0x97,
      0x2b,
      0x51,
      0x56,
      0xe8,
      0x88,
      0xf6,
      0x07,
      0xbc,
      0xdf,
      0xfa,
      0x2b,
      0x7b,
      0x88,
      0xe0,
      0x46,
      0xc8,
      0x7a,
      0x3e,
      0xd8,
      0x80,
      0xdb,
      0x4d,
      0x87,
      0x61,
      0x4f,
      0x64,
      0xcd,
      0xeb,
      0xe8,
      0x0d,
      0x86,
      0x16,
      0xcc,
      0xdd,
      0x6c,
      0x76,
      0x66,
      0xc1,
      0x73,
      0xb7,
      0x08,
      0x98,
      0x89,
      0x2f,
      0x67,
      0x69,
      0xd1,
      0xfc,
      0x97,
      0x4d,
      0xa2,
      0xce,
      0xad,
      0xbb,
      0x6f,
      0xab,
      0xa5,
      0xd6,
      0x18,
      0xb3,
      0x1a,
      0x96,
      0x02,
      0xbc,
      0x31,
      0x42,
      0xa2,
      0xad,
      0x77,
      0xe8,
      0xe2,
      0x4c,
      0x99,
      0xf9,
      0xdd,
      0xbe,
      0xcd,
    ]).toBigInt();
    final xValue = Uint8List.fromList([
      0x01,
      0x00,
      0x9b,
      0x58,
      0xa8,
      0xf4,
      0x04,
      0xb1,
      0xd5,
      0x14,
      0x09,
      0xe1,
      0xe1,
      0xa1,
      0x8a,
      0x0b,
      0xa3,
      0xc3,
      0xa3,
      0x66,
      0xaa,
      0x27,
      0x99,
      0x50,
      0x1c,
      0x4d,
      0xba,
      0x24,
      0xee,
      0xdf,
      0xdf,
      0xb8,
      0x8e,
      0x8e,
    ]).toBigInt();

    final privateKey = DSAPrivateKey(xValue, pValue, qValue, gValue);
    final publicKey = privateKey.publicKey;

    final message = faker.lorem.words(100).join(' ').stringToBytes();

    test('With sha1 test', (() {
      final signer = DSASigner(Digest('SHA-1'));

      signer.init(true, DSAKeyParameters(privateKey));
      final signature = signer.generateSignature(message);
      signer.init(false, DSAKeyParameters(publicKey));
      if (signer.verifySignature(message, signature)) {
        print('verified');
      }
      // expect(signer.verifySignature(message, signature), true);
    }));

    test('With sha256 test', (() {
      // final signer = DSASigner(Digest('SHA-256'));

      // signer.init(true, DSAKeyParameters(DSAPrivateKey(xValue, pValue, qValue, gValue)));
      // final signature = signer.generateSignature(message);
      // signer.init(false, DSAKeyParameters(DSAPublicKey(yValue, pValue, qValue, gValue)));
      // if (!signer.verifySignature(message, signature)) {
      //   print('object');
      // }
      // expect(signer.verifySignature(message, signature), true);
    }));
  }));
}

void _elGamalEncryptionTest(BigInt p, BigInt g, int size) {
  final x = _dhCalculatePrivateKey(p);
  final privateKey = ElGamalPrivateKey(x, p, g);
  final publicKey = privateKey.publicKey;

  final engine = ElGamalEngine();
  engine.init(true, ElGamalKeyParameters(publicKey));
  expect(engine.outputBlockSize, size ~/ 4, reason: "$size outputBlockSize on encryption failed.");

  final message = "5468697320697320612074657374".hexToBytes();
  final plainText = message;
  final cipherText = Uint8List(engine.outputBlockSize);
  engine.processBlock(plainText, 0, plainText.length, cipherText, 0);

  engine.init(false, ElGamalKeyParameters(privateKey));
  engine.processBlock(cipherText, 0, cipherText.length, plainText, 0);

  expect(engine.outputBlockSize, (size ~/ 8) - 1, reason: "$size outputBlockSize on decryption failed.");
  expect(message, equals(plainText), reason: '$size bit test failed');
}

BigInt _dhCalculatePrivateKey(BigInt p) {
  final random = newSecureRandom();
  final min = BigInt.two;
  final max = p - BigInt.two;
  final minWeight = max.bitLength >> 2;
  var x = random.nextBigInteger(max.bitLength);
  while ((x.compareTo(min) < 0) || (x.compareTo(max) > 0) || (_getNafWeight(x) < minWeight)) {
    x = random.nextBigInteger(max.bitLength);
  }
  return x;
}

int _getNafWeight(BigInt k) {
  if (k.sign == 0) {
    return 0;
  }
  final k3 = (k << 1) + k;
  final diff = k3 ^ k;
  return diff.bitLength;
}
